(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{586:function(t,a,n){"use strict";n.r(a);var s=n(4),e=Object(s.a)({},(function(){var t=this,a=t.$createElement,n=t._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("p",[t._v("起初是 Dubbo 无法实例化不可变对象")]),t._v(" "),n("p",[t._v("曾 XX 9-10 15:13:07"),n("br"),t._v(" "),n("img",{staticStyle:{margin:"0 auto",display:"block"},attrs:{src:"https://cdn.jsdelivr.net/gh/ty-peng/pic-bed/img/202009151113-troubleshoot-record-1.png",alt:"202009151113-troubleshoot-record-1"}}),t._v("\n这种错误是直接转换复制一遍？[奸笑]@周 XX")]),t._v(" "),n("p",[t._v("曾 XX 9-10 15:16:29")]),t._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SnsEntityMapBean")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("convertToNormalSnsEntityMapBeanList")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SnsEntityMapBean")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" list"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CollectionUtils")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("isEmpty")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("list"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Lists")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("newArrayList")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),n("span",{pre:!0,attrs:{class:"token generics"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SnsEntityMapBean")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" result "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Lists")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("newArrayList")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SnsEntityMapBean")]),t._v(" bean "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" list"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SnsEntityMapBean")]),t._v(" newBean "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SnsEntityMapBean")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BeanUtils")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("copyPropertiesIgnoreNull")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newBean"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" bean"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        result"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("newBean"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" result"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("原来已经有这么个方法了[奸笑]")]),t._v(" "),n("p",[t._v("纪 XX 9-10 15:17:36"),n("br"),t._v("\n其实上次 XX 分享时举过这个例子[机智]")]),t._v(" "),n("p",[t._v("王 XX 9-10 15:24:34"),n("br"),t._v("\n可以考虑直接暴露不可变 bean")]),t._v(" "),n("p",[t._v("曾 XX 9-10 15:24:56"),n("br"),t._v("\n暴露了也不行, set 方法不可用")]),t._v(" "),n("p",[t._v("王 XX 9-10 15:25:00"),n("br"),t._v("\n这个是因为 client 没有定义")]),t._v(" "),n("p",[t._v("王 XX 9-10 15:25:20"),n("br"),t._v("\n既然暴露的是不可变的，就是不允许修改")]),t._v(" "),n("p",[t._v("王 XX 9-10 15:25:42"),n("br"),t._v("\n业务里面不去修改它才是对的")]),t._v(" "),n("p",[t._v("曾 XX 9-10 15:25:57"),n("br"),t._v("\n可是反序列化是要调用 set 方法的")]),t._v(" "),n("p",[t._v("王 XX 9-10 15:27:24"),n("br"),t._v("\n你要看是哪种序列化方式")]),t._v(" "),n("p",[t._v("王 XX 9-10 15:29:10")]),t._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ImmutableSnsEntityMapBean")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SnsEntityMapBean")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ImmutableSnsEntityMapBean")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SnsEntityMapBean")]),t._v(" entityMap"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BeanUtils")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("copyProperties")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" entityMap"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("immutable "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("王 XX 9-10 15:29:22"),n("br"),t._v("\n先把默认构造方法补上")]),t._v(" "),n("p",[t._v("曾 XX 9-10 15:41:20")]),t._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ImmutableSnsEntityMapBean")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SnsEntityMapBean")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ImmutableSnsEntityMapBean")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SnsEntityMapBean")]),t._v(" entityMap"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BeanUtils")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("copyProperties")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" entityMap"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("immutable "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ImmutableSnsEntityMapBean")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("加默认构造方法不行")]),t._v(" "),n("p",[t._v("王 XX 9-15 10:24:38"),n("br"),t._v("\n这个问题，这个问题 bean 只要有默认构造方法和声明了 Serializable 就可以进行序列化和反序列化"),n("br"),t._v("\n测试或部署过程出现失败一半都是因为部署上的问题，你可能调到了一个老的服务或是一个老的服务在调你"),n("br"),t._v("\n在服务化场景下，异常是会级联输出的 如 A -> B -> C C 异常 A 上没有特殊处理的情况下，也会看到 C 的堆栈"),n("br"),t._v("\n当前线上发生过几次的场景是 core 调用 partdb， partdb 执行业务的时候又调用 core，这时如果没有注意依赖关系，就容易产生故障"),n("br"),t._v("\n昨天运维新加 api 机器，默认启动了一个老的 API, 导致线上大量异常，看异常都是 partdb 评论什么的服务错误，但你实际跟踪堆栈，就会发现调用链最先发生异常的位置是评论调用 core 的服务"),n("br"),t._v("\n昨天我也不知道运维新加 api 机器，我推断出这个的信息是，服务调用异常都会给出调用方和服务提供方 IP, 而相关错误的 IP 集中在 53 54 这种，并且这个机器不在我的列表里面")]),t._v(" "),n("p",[t._v("王 XX 9-15 10:25:36"),n("br"),t._v("\n上面序列化的验证，当前预发布环境部署的就是修改后的代码，你们可以给我检查一下，防止我这边也验证错误")]),t._v(" "),n("p",[t._v("王 XX 9-15 10:30:12")]),t._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("2020-09-14 16:05:12,180 [DubboServerHandler-192.168.1.99:20882-thread-101] ERROR [org.apache.dubbo.rpc.filter.ExceptionFilter$ExceptionListener] -  [DUBBO] Got unchecked and undeclared exception which called by null. service: xxx.xxx.xxx.msg.client.service.ICommentService, method: getTopCommentIds, exception: java.lang.RuntimeException: org.mybatis.spring.MyBatisSystemException: nested exception is org.apache.ibatis.exceptions.PersistenceException:\n### Error querying database.  Cause: org.springframework.jdbc.CannotGetJdbcConnectionException: Failed to obtain JDBC Connection; nested exception is com.alibaba.druid.pool.DataSourceClosedException: dataSource already closed at Mon Sep 14 16:05:11 CST 2020\n### The error may exist in URL [jar:file:/usr/local/tomcat6/webapps/xxx/WEB-INF/lib/xxx-core-dao-8.0.4.jar!/sqlmap/sns_entity_map_sqlmap.xml]\n### The error may involve SnsEntityMapDAO.getSnsEntityMapList\n### The error occurred while executing a query\n### Cause: org.springframework.jdbc.CannotGetJdbcConnectionException: Failed to obtain JDBC Connection; nested exception is com.alibaba.druid.pool.DataSourceClosedException: dataSource already closed at Mon Sep 14 16:05:11 CST 2020\norg.mybatis.spring.MyBatisSystemException: nested exception is org.apache.ibatis.exceptions.PersistenceException:\n### Error querying database.  Cause: org.springframework.jdbc.CannotGetJdbcConnectionException: Failed to obtain JDBC Connection; nested exception is com.alibaba.druid.pool.DataSourceClosedException: dataSource already closed at Mon Sep 14 16:05:11 CST 2020\n### The error may exist in URL [jar:file:/usr/local/tomcat6/webapps/xxx/WEB-INF/lib/xxx-core-dao-8.0.4.jar!/sqlmap/sns_entity_map_sqlmap.xml]\n### The error may involve SnsEntityMapDAO.getSnsEntityMapList\n### The error occurred while executing a query\n### Cause: org.springframework.jdbc.CannotGetJdbcConnectionException: Failed to obtain JDBC Connection; nested exception is com.alibaba.druid.pool.DataSourceClosedException: dataSource already closed at Mon Sep 14 16:05:11 CST 2020\n        at org.mybatis.spring.MyBatisExceptionTranslator.translateExceptionIfPossible(MyBatisExceptionTranslator.java:79)\n        at org.mybatis.spring.SqlSessionTemplate$SqlSessionInterceptor.invoke(SqlSessionTemplate.java:447)\n        at com.sun.proxy.$Proxy41.selectList(Unknown Source)\n        at org.mybatis.spring.SqlSessionTemplate.selectList(SqlSessionTemplate.java:231)\n        at xxx.xxx.xxx.core.dao.sns.mybatis.SnsEntityMapDaoMybatis.getList(SnsEntityMapDaoMybatis.java:280)\n        at xxx.xxx.xxx.core.service.manager.EntityMapManager.getList(EntityMapManager.java:1136)\n        at xxx.xxx.xxx.core.service.facade.CoreServiceFacadeImpl.getList(CoreServiceFacadeImpl.java:1220)\n        at xxx.xxx.xxx.core.service.facade.CoreServiceFacadeImpl$$FastClassBySpringCGLIB$$182d77dd.invoke(<generated>)\n        at org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:204)\n        at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.invokeJoinpoint(CglibAopProxy.java:746)\n        at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163)\n        at org.springframework.transaction.interceptor.TransactionAspectSupport.invokeWithinTransaction(TransactionAspectSupport.java:294)\n        at org.springframework.transaction.interceptor.TransactionInterceptor.invoke(TransactionInterceptor.java:98)\n        at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:185)\n")])])]),n("p",[t._v("另外系统异常的情况，会伴生很多奇怪的错误，这个时候就要做出判断，优先解决一些可以识别的错误，上面这个堆栈就是做过发生异常时伴生的错误，如果你的精力在解决在定位这个问题，大概几天之内都不会有任何结果")]),t._v(" "),n("p",[t._v("纪 XX 9-15 10:32:19"),n("br"),t._v("\n报错不准确 相当于谎报军情 很难了[捂脸]")]),t._v(" "),n("p",[t._v("纪 XX 9-15 10:33:08"),n("br"),t._v("\ndubbo 是不是有什么配置可以避免下这种级联输出的错误?")]),t._v(" "),n("p",[t._v("王 XX 9-15 10:33:21"),n("br"),t._v("\n其实是准确的，异常堆栈会有几级，你要看完整堆栈")]),t._v(" "),n("p",[t._v("王 XX 9-15 10:33:36"),n("br"),t._v("\n找出关键因素")]),t._v(" "),n("p",[t._v("王 XX 9-15 10:34:25"),n("br"),t._v("\n如果对异常进行拦截等处理，很可能出现的一个问题是发生异常了你不知道")]),t._v(" "),n("p",[t._v("王 XX 9-15 10:34:57"),n("br"),t._v("\n因为有各种默认处理逻辑，任何一个处理不到位都有可能导致异常信息丢失")]),t._v(" "),n("p",[t._v("纪 XX 9-15 10:35:12"),n("br"),t._v("\n准确但不全面, 最好是哪台机器报错就在哪台打印")]),t._v(" "),n("p",[t._v("王 XX 9-15 10:35:31"),n("br"),t._v("\n伴生异常的问题基本无解，只能靠经验")]),t._v(" "),n("p",[t._v("王 XX 9-15 10:39:55"),n("br"),t._v("\nCannotGetJdbcConnectionException 的问题可能隐藏了一个技术问题，大家感兴趣的可以自行定位看看")]),t._v(" "),n("p",[t._v("曾 XX 9-15 10:40:54"),n("br"),t._v("\n昨天我碰到的那种异常也是很蛋疼,因为某个字段对象没有序列化,导致发送请求超时,在调用端的异常是 timeout，被调用端是完全无信息,报错一点都不准确[奸笑]")]),t._v(" "),n("p",[t._v("王 XX 9-15 10:42:30"),n("br"),t._v("\n这个是框架层的问题，你们可以定位一下原因，如果能够对它进行修复，你也算是开源贡献者了")]),t._v(" "),n("p",[t._v("王 XX 9-15 10:42:54"),n("br"),t._v("\n可以先试下新版本有没有这个问题")])])}),[],!1,null,null,null);a.default=e.exports}}]);